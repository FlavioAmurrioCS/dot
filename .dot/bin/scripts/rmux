#!/usr/bin/env bash

# shellcheck source=../scripts/__script_utilities.sh
SCRIPT_HOME="$(dirname "$(cd "$(dirname "${0}")" >/dev/null 2>&1 && pwd -P)")/scripts" &&
  [ -f "${SCRIPT_HOME}/__script_utilities.sh" ] &&
  source "${SCRIPT_HOME}/__script_utilities.sh"

function rmux() {
  local host="${USER}.BLANK"
  [[ -n ${1} && "${1}" != -* ]] && host="${1}" && shift 1
  local usage="
  ${FUNCNAME[0]:-rmux} [hostname]

  Terminal multiplexer. It allows multiple sessions with windows, panes, and more.
  More information: <https://github.com/tmux/tmux>.

  Intro to tmux: https://www.hamvocke.com/blog/a-quick-and-easy-guide-to-tmux/
  Tmux Configuration: https://www.hamvocke.com/blog/a-guide-to-customizing-your-tmux-conf/

    Split pane horizontally                   Create new window
    Ctrl-a -                                  Ctrl-a c

    Split pane vertically                     Switch between windows
    Ctrl-a |                                  Ctrl-a p|n|<number> for previous

    Change pane focus                         Rename window(prompt at bottom of screen)
    Ctrl-a <arrow keys>                       Ctrl-a ,

    Make pane go full screen/shrink           Detach from the current session
    Ctrl-a z                                  Ctrl-a d

    Resize pane or use mouse if enabled.      Kill the current session
    Ctrl-a Ctrl-<arrow key>                   Ctrl-a :kill-session<Enter>

    Close pane                                Help dialog
    Ctrl-d or type 'exit -f'                  Ctrl-a ?

    Ctrl-1 Esc 1-5    Arrange panes in one of the five preset layouts:
                      even-horizontal, even-vertical, main-horizontal,
                      main-vertical, or tiled.
    "
  help_arg_count_usage 0 "${usage}" "$@" && return 0
  [ -n "${TMUX}" ] && {
    log_warning "Should not open tmux inside tmux, ssh-ing instead."
    ssh "${host}"
    return
  }
  log_warning "Target host: ${host}"
  # TODO: Decide on whether to install tmux globally on every box
  # shellcheck disable=SC2016
  local init='
    cat > ${HOME}/.rmux.tmux.conf
    export PATH="${HOME}/.dot/bin/linux/:${HOME}/.local/bin:/tmp/usr/bin:${PATH}"
    if ! command tmux -V 2>/dev/null | grep -q "tmux 3" 2>/dev/null; then
      echo -e "\033[1;33mtmux3 not found. Attemping to install tmux..." 1>&2
      # if ! sudo -n echo >/dev/null 2>&1; then
        # sudo -n yum install -y https://BLANK/tmux-3.0a-1.el7.x86_64.rpm 1>&2
      # else
        cd /tmp &&
          { curl -s https://BLANK/tmux-3.0a-1.el7.x86_64.rpm | rpm2cpio - | cpio -idmv; } >/dev/null 2>&1 ||
          exit 1
          mkdir -p ~/.local/bin
          cp /tmp/usr/bin/tmux ~/.local/bin
          rm -rf /tmp/usr
      # fi
    fi
    hash -r
    tmux ls 2>/dev/null
    echo "<create new session>"
  '
  local selection
  export FZF_DEFAULT_OPTS="${FZF_DEFAULT_OPTS} --select-1"
  selection="$(ssh "${ssh_options[@]}" "${host}" ''"${init}"'' <"${HOME}/.tmux.conf" | select_one)" || return 1

  # shellcheck disable=SC2016
  local tmux_cmd='
    export PATH="${HOME}/.dot/bin/linux/:${HOME}/.local/bin:/tmp/usr/bin:${PATH}"
    tmux_conf="${HOME}/.rmux.tmux.conf"
    [ -f "${HOME}/.tmux.conf" ] && tmux_conf="${HOME}/.tmux.conf"
    tmux -f ${tmux_conf}'
  case "${selection}" in
  "<create new session>")
    local new_sesssion_name
    read -r -p "New Tmux Session Name: " new_sesssion_name
    ssh -S none -t "${host}" ''"${tmux_cmd}"' new-session -s '"${new_sesssion_name}"
    ;;
  *:*)
    local session_name
    session_name="$(echo "${selection}" | cut -d ":" -f1)"
    ssh -S none -t "${host}" ''"${tmux_cmd}"' attach-session -t '"${session_name}"
    ;;
  *)
    echo "WHAT HAPPENED! ${selection}"
    ;;
  esac
}

rmux "${@}"
